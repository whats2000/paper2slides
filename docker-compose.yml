version: '3.8'

services:
  # Streamlit web app
  paper2slides:
    build: .
    ports:
      - "8501:8501"
    volumes:
      - ./source:/app/source
      - ./cache:/app/cache
      - ./.env:/app/.env
      - ./app.py:/app/app.py
      - ./paper2slides.py:/app/paper2slides.py
      - ./tex2beamer.py:/app/tex2beamer.py
      - ./beamer2pdf.py:/app/beamer2pdf.py
      - ./src:/app/src
      - ./prompts:/app/prompts
    stdin_open: true
    tty: true
    networks:
      - paper2slides-network

  # FastAPI service
  paper2slides-api:
    build:
      context: .
      dockerfile: Dockerfile.api
    ports:
      - "${API_PORT:-8000}:8000"  # Map host port to container port 8000
    volumes:
      - ./api_workspaces:/app/api_workspaces
      - ./cache:/app/cache
      - ./source:/app/source
      - ./.env:/app/.env
      - ./api.py:/app/api.py
      - ./src:/app/src
      - ./prompts:/app/prompts
    environment:
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - OPENAI_BASE_URL=${OPENAI_BASE_URL}
      - DEFAULT_MODEL=${DEFAULT_MODEL:-gpt-4o-2024-11-20}
    restart: unless-stopped
    networks:
      - paper2slides-network

  # pdffigures2 service for basic figure extraction
  pdffigures2:
    image: paper2slides-pdffigures2:latest
    build:
      context: .
      dockerfile: Dockerfile.pdffigures2
    volumes:
      - ./cache:/data/cache
      - ./source:/data/source
      - ./demo:/data/demo
      - ./test_output:/data/test_output
    networks:
      - paper2slides-network
    # pdffigures2 is a CLI tool, not a service - use 'docker-compose run' to execute it
    # Keep container running for exec commands
    command: tail -f /dev/null
    restart: unless-stopped

  # YOLO11 Document Layout service for ML-based figure extraction
  yolo11-doc-layout:
    image: paper2slides-yolo11-doc-layout:latest
    build:
      context: .
      dockerfile: Dockerfile.yolo11-doc-layout
    volumes:
      - ./cache:/data/cache
      - ./source:/data/source
      - ./demo:/data/demo
      - ./test_output:/data/test_output
    networks:
      - paper2slides-network
    # YOLO11 is a CLI tool, not a service - use 'docker-compose exec' to run it
    # Keep container running for exec commands
    command: tail -f /dev/null
    restart: unless-stopped

networks:
  paper2slides-network:
    driver: bridge
